#!/bin/sh

set -e

# Create the backup on heroku
heroku pg:backups capture -a brewdega-cellar

# Download the backup
curl -# -o /tmp/brewdega-cellar.dump `heroku pg:backups public-url -a brewdega-cellar | cat`

# Restore the backup
dropdb cellar_development
createdb -T template0 cellar_development

pg_restore --verbose --no-acl --no-owner -h 127.0.0.1 -U `whoami` -d cellar_development /tmp/brewdega-cellar.dump

# Clean up
rm -f /tmp/brewdega-cellar.dump

# Reindex PostgreSQL
#rake pg_search:multisearch:rebuild_all

set +e
